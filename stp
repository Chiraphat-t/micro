#include <WiFi.h>
#include <MQTT.h>
#include <AccelStepper.h>

// --- การตั้งค่า Pin ---
#define LDR_PIN 34 
// ลำดับพินสำหรับ ULN2003: IN1, IN3, IN2, IN4 เพื่อความสมูทที่สุด
AccelStepper stepper(AccelStepper::FULL4WIRE, 23, 22, 19, 18); 

// --- การตั้งค่า Network ---
const char ssid[] = "@JumboPlusIoT";
const char pass[] = "07450748";
const char mqtt_broker[] = "test.mosquitto.org";
const char mqtt_client_id[] = "ESP32_Stepper_Group4"; // ควรตั้งชื่อให้ไม่ซ้ำ

// Topics
const char topic_ldr[] = "groupAi4/ldr";
const char topic_degree[] = "groupAi4/degree";
const char topic_command[] = "groupAi4/command"; 

WiFiClient net;
MQTTClient client;

// --- ตัวแปรควบคุม ---
const int stepsPerRevolution = 2048; 
bool isEmergency = false; 
unsigned long lastReportTime = 0;

// --- ฟังก์ชันเชื่อมต่อ WiFi ---
void connectWiFi() {
  if (WiFi.status() == WL_CONNECTED) return;
  Serial.print("\nConnecting to WiFi...");
  WiFi.begin(ssid, pass);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\nWiFi Connected!");
}

// --- ฟังก์ชันเชื่อมต่อ MQTT ---
void connectMQTT() {
  if (WiFi.status() != WL_CONNECTED) return;
  if (client.connected()) return;
  Serial.print("Connecting to MQTT...");
  while (!client.connect(mqtt_client_id)) {
    delay(1000); Serial.print(".");
  }
  Serial.println("\nMQTT Connected!");
  client.subscribe(topic_command);
}

// --- ฟังก์ชันเมื่อได้รับคำสั่งผ่าน MQTT ---
void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming Command: " + payload);
  
  if (payload == "stop" || payload == "emergency") {
    isEmergency = true;
    stepper.stop();
  } 
  else if (payload == "start") {
    isEmergency = false;
  }
  else if (payload == "reset") {
    stepper.setCurrentPosition(0); // ตั้งจุดปัจจุบันเป็น 0 องศา
  }
  // ถ้า payload เป็นตัวเลข เช่น "90", "180", "360"
  else if (payload.toInt() != 0 || payload == "0") {
    float targetDeg = payload.toFloat();
    // สูตรแปลงองศาเป็น Step: (องศา / 360) * 2048
    long targetStep = (targetDeg / 360.0) * stepsPerRevolution;
    
    Serial.print("Moving to Degree: "); Serial.println(targetDeg);
    stepper.moveTo(targetStep); 
  }
}

void setup() {
  Serial.begin(115200);
  
  // ตั้งค่ามอเตอร์
  stepper.setMaxSpeed(800);    // ความเร็วสูงสุด
  stepper.setAcceleration(500); // ความเร่ง
  
  client.begin(mqtt_broker, 1883, net);
  client.onMessage(messageReceived);
  
  connectWiFi();
  connectMQTT();
}

void loop() {
  // ตรวจสอบการเชื่อมต่อ
  if (WiFi.status() != WL_CONNECTED) connectWiFi();
  if (!client.connected()) connectMQTT();
  client.loop();

  // 1. อ่านค่าและรายงานผลทุก 1 วินาที
  if (millis() - lastReportTime > 1000) {
    int ldrValue = analogRead(LDR_PIN);
    
    // คำนวณองศาปัจจุบันจากตำแหน่งมอเตอร์
    float currentDeg = (float)stepper.currentPosition() / stepsPerRevolution * 360.0;
    
    // ส่งข้อมูลไป MQTT
    client.publish(topic_ldr, String(ldrValue));
    client.publish(topic_degree, String(currentDeg, 1));
    
    Serial.print("LDR: "); Serial.print(ldrValue);
    Serial.print(" | Current Degree: "); Serial.println(currentDeg, 1);
    
    lastReportTime = millis();
  }

  // 2. การควบคุมมอเตอร์
  if (!isEmergency) {
    // ทำงานตามเป้าหมาย (moveTo) ที่ได้รับจาก MQTT
    stepper.run(); 
  }
}
